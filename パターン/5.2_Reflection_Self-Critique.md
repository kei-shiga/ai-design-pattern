# 5.2 Reflection / Self-Critique (自己反省ループ)

## 概要
AIが出力したコードや回答を即座にユーザーに提示するのではなく、**AI自身（または別のAIロール）に「自己評価」と「修正」を行わせてから出力する**パターンです。これにより、ケアレスミスや要件漏れを未然に防ぎます。

## 詳細・実施手順

1. **Drawft Generation (ドラフト生成):**
   * 通常通り、AIにタスクを実行させ、初稿（Draft）を生成させます。

2. **Evaluation (評価・批評):**
   * 生成されたDraftに対して、以下の観点で批評を行います。
     * 構文エラーはないか？
     * 要求された制約条件（ライブラリ制限など）を守っているか？
     * セキュリティ上の懸念はないか？
     * もっと効率的な書き方はないか？

3. **Refinement (修正):**
   * 批評内容（Critiques）を元に、Draftを修正して最終版を作成します。

4. **Iterative Loop (反復):**
   * 高品質な出力が必要な場合、評価と修正のループを複数回（2~3回）回します（例: Reflexionパターン）。

## ワークフロー例 (Prompt Chain)

**Step 1: コード生成**
> "ユーザー一覧を取得するAPIエンドポイントをFlaskで書いてください。"

**(Output 1: Draft Code)**

**Step 2: 自己評価 (Reflect)**
> "上記のコードをレビューしてください。特にSQLインジェクションの脆弱性と、エラーハンドリングの欠如がないか確認してください。"

**(Output 2: Critique)**
> "SQLを文字列結合で構築しており脆弱性があります。また、DB接続エラー時のtry-catchがありません。"

**Step 3: 修正 (Refine)**
> "指摘事項を踏まえて、コードを修正してください。"

**(Output 3: Final Code)**

## サンプルプロンプト (One-Shot Reflection)

一回のプロンプト内で思考・批評を行わせる手法（Chain-of-Thoughtの一種）です。

```markdown
# Task
Pythonで素数を判定する関数を書いてください。

# Procedure
1. まず、シンプルな実装を考えてください（Draft）。
2. その実装のエッジケース（1, 負数, 大きな数）やパフォーマンスを批評してください（Critique）。
3. 批評を元に、最適化された最終的なコードを書いてください（Final Code）。

出力は最終的なコードブロックのみを見せてください。
```

## メリット
- **品質向上:** 人間がレビューする前に、AI自身が単純ミスを潰してくれます。
- **ロバスト性:** エッジケースへの考慮漏れが減ります。
- **教育効果:** AIが「なぜ修正したか」を出力する場合、ユーザーにとっても学びになります。
