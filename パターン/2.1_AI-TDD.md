# 2.1 AI-TDD (AI-Driven Test Driven Development)

## æ¦‚è¦
AIãŒç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã«æ··å…¥ã™ã‚‹å¾®å¦™ãªãƒã‚°ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã‚’é˜²ããŸã‚ã€**AIã«å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ã›ã‚‹å‰ã«ã€ã¾ãšãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ã›ã‚‹ï¼ˆã‚ã‚‹ã„ã¯äººé–“ãŒãƒ†ã‚¹ãƒˆã‚’æä¾›ã™ã‚‹ï¼‰** æ‰‹æ³•ã§ã™ã€‚ã€Œãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã¾ã§AIã«ä¿®æ­£ã•ã›ã‚‹ã€ã¨ã„ã†ãƒ«ãƒ¼ãƒ—ã‚’å›ã™ã“ã¨ã§ã€å“è³ªã‚’æ‹…ä¿ã—ã¾ã™ã€‚

## è©³ç´°ãƒ»å®Ÿæ–½æ‰‹é †

å‹•ãã‚³ãƒ¼ãƒ‰ã‚’ã„ããªã‚Šç”Ÿæˆã•ã›ã‚‹ã®ã§ã¯ãªãã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆRed-Green-Refactorï¼‰ã‚’AIã¨å…±ã«å®Ÿè¡Œã—ã¾ã™ã€‚

1. **Red (Test Creation):**
  * äººé–“ãŒä»•æ§˜ã‚’æç¤ºã—ã€AIã«ã€Œã“ã®ä»•æ§˜ã‚’æº€ãŸã™ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼‰ã€ã‚’ä½œæˆã•ã›ã¾ã™ã€‚
  * ã¾ãŸã¯ã€äººé–“ãŒãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å…ˆã«è¨˜è¿°ã—ã¾ã™ã€‚
  * ã“ã®æ™‚ç‚¹ã§ã¯å®Ÿè£…ãŒãªã„ãŸã‚ã€ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã—ã¾ã™ã€‚

2. **Green (Implementation):**
  * ä½œæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’AIã«æ¸¡ã—ã€ã€Œã“ã®ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã™ã‚‹æœ€å°é™ã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã€ã‚’ä½œæˆã•ã›ã¾ã™ã€‚
  * ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€å¤±æ•—ã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’AIã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã—ã¦ä¿®æ­£ã•ã›ã¾ã™ã€‚

3. **Refactor (Optimization):**
  * ãƒ†ã‚¹ãƒˆãŒé€šã£ãŸçŠ¶æ…‹ã§ã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Šã‚„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’AIã«ä¾é ¼ã—ã¾ã™ã€‚
  * ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€æ©Ÿèƒ½å¾Œé€€ï¼ˆãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ï¼‰ã‚’é˜²ãã¾ã™ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

AIã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã‚’æŒ‡ç¤ºã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ã§ã™ã€‚

```markdown
# Role
ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸQAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å…¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã§ã™ã€‚

# Task
ä»¥ä¸‹ã®[è¦ä»¶]ã‚’æº€ãŸã™Pythonã®é–¢æ•° `calculate_discount` ã®ãŸã‚ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ(pytest)ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ã¾ã å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚ã¾ãšã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼ˆå¢ƒç•Œå€¤ã€ç•°å¸¸ç³»ï¼‰ã‚’ç¶²ç¾…ã™ã‚‹ã“ã¨ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚

# è¦ä»¶
- åˆè¨ˆé‡‘é¡ãŒ5000å††ä»¥ä¸Šã§10%ã‚ªãƒ•
- åˆè¨ˆé‡‘é¡ãŒ10000å††ä»¥ä¸Šã§20%ã‚ªãƒ•
- ä¼šå“¡ãƒ•ãƒ©ã‚°ãŒTrueã®å ´åˆã¯ã•ã‚‰ã«5%ã‚ªãƒ•ï¼ˆå‰²å¼•ç‡ã«åŠ ç®—ï¼‰
- å‰²å¼•é¡ã¯æ•´æ•°ã«åˆ‡ã‚Šæ¨ã¦
```

## å®Ÿè·µã‚¬ã‚¤ãƒ‰ (Visual Studio / C# .NET)

Pythonç­‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨€èªã¨ç•°ãªã‚Šã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ãªC#ç’°å¢ƒã§ã¯ã€IDEçµ±åˆæ©Ÿèƒ½ã‚’æ´»ç”¨ã™ã‚‹ã®ãŒæœ€ã‚‚åŠ¹ç‡çš„ã§ã™ã€‚

### 1. IDEçµ±åˆæ©Ÿèƒ½ã‚’ä½¿ã†å ´åˆ (æ¨å¥¨)
Visual Studio ã® **GitHub Copilot Chat** ã‚’æ´»ç”¨ã™ã‚‹ã¨ã€ã‚¹ãƒ ãƒ¼ã‚ºãªTDDã‚µã‚¤ã‚¯ãƒ«ãŒå›ã›ã¾ã™ã€‚

1. **Red (Test):**
   * ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ (MSTest/xUnit) ã«ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
   * å®Ÿè£…ãŒãªã„ãŸã‚ã€ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã‚„èµ¤ç·šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
2. **Green (Implement):**
   * å¤±æ•—ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã€`Alt + /` (ã¾ãŸã¯å³ã‚¯ãƒªãƒƒã‚¯ > Copilot) ã§ãƒãƒ£ãƒƒãƒˆã‚’é–‹ãã¾ã™ã€‚
   * **Prompt:** `ã“ã®ãƒ†ã‚¹ãƒˆã‚’é€šã™ãŸã‚ã® [ã‚¯ãƒ©ã‚¹å] ã®å®Ÿè£…ã‚’æ›¸ã„ã¦ã€‚`
   * ææ¡ˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ã€ŒæŒ¿å…¥ã€ã—ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
3. **Refactor:**
   * ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ä¿®æ­£ã•ã›ã¾ã™ã€‚
   * **Prompt:** `ã“ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚ä¿®æ­£ã—ã¦ã€‚ [ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è²¼ã‚Šä»˜ã‘]`

### 2. PowerShellã§è‡ªå‹•åŒ–ã™ã‚‹å ´åˆ (è©³ç´°åˆ¶å¾¡)
ã€Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ ä¿®æ­£ã€ã®ãƒ«ãƒ¼ãƒ—ã‚’å®Œå…¨ã«è‡ªå‹•åŒ–ã—ãŸã„å ´åˆã¯ã€PowerShellã¨OpenAI APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

**äº‹å‰æº–å‚™:**
* ç’°å¢ƒå¤‰æ•° `OPENAI_API_KEY` ã«APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

```powershell
# AutoCoder.ps1
# å®Ÿè¡Œæ–¹æ³•: .\AutoCoder.ps1

# è¨­å®š
$TestProject = "./MyTests/MyTests.csproj" # ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹
$TargetFile = "./MyApp/Calculator.cs"     # å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã®ãƒ‘ã‚¹
$MaxAttempts = 3
$ApiKey = $env:OPENAI_API_KEY
$ApiUrl = "https://api.openai.com/v1/chat/completions"

function Request-AI-Fix ($currentCode, $errorLog) {
  $prompt = @"
ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸC#ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’åˆ†æã—ã€ä¿®æ­£ã—ãŸå®Œå…¨ãªC#ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
Markdownè¨˜å·ã‚„è§£èª¬ã¯ä¸è¦ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

[ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰]
$currentCode

[ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°]
$errorLog
"@

  # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
  $body = @{
    model = "gpt-4o"
    messages = @(
      @{ role = "system"; content = "You are a C# coding assistant. Output only raw code." }
      @{ role = "user"; content = $prompt }
    )
    temperature = 0.0
  } | ConvertTo-Json -Depth 10

  # APIå‘¼ã³å‡ºã—
  $response = Invoke-RestMethod -Uri $ApiUrl -Method Post -Headers @{ "Authorization" = "Bearer $ApiKey" } -ContentType "application/json" -Body $body
  
  # æ•´å½¢ï¼ˆMarkdownè¨˜å·é™¤å»ï¼‰
  $fixedCode = $response.choices[0].message.content
  $fixedCode = $fixedCode -replace "^```csharp", "" -replace "^```", "" -replace "```$", ""
  return $fixedCode.Trim()
}

# ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
for ($i = 1; $i -le $MaxAttempts; $i++) {
  Write-Host "`nAttempt $i / $MaxAttempts : Running tests..." -ForegroundColor Cyan
  
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚‚å«ã‚ã¦ã‚­ãƒ£ãƒ—ãƒãƒ£)
  $testOutput = dotnet test $TestProject 2>&1 | Out-String

  if ($LASTEXITCODE -eq 0) {
    Write-Host "`nğŸ‰ Success! All tests passed." -ForegroundColor Green
    exit
  }

  Write-Host "Tests Failed. Asking AI to fix..." -ForegroundColor Yellow

  # ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
  if (Test-Path $TargetFile) {
    $currentCode = Get-Content $TargetFile -Raw -Encoding UTF8
  } else {
    $currentCode = ""
  }

  # AIã«ä¿®æ­£ä¾é ¼
  $newCode = Request-AI-Fix $currentCode $testOutput

  # ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šæ›¸ã
  Set-Content -Path $TargetFile -Value $newCode -Encoding UTF8
  Write-Host "Updated $TargetFile"
}

Write-Host "`nâŒ Failed within max attempts." -ForegroundColor Red
```

## ãƒ¡ãƒªãƒƒãƒˆ
- **ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®æ¤œçŸ¥:** AIãŒä»•æ§˜ã‚’èª¤è§£ã—ã¦ã„ã¦ã‚‚ã€ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã§å³åº§ã«æ°—ã¥ã‘ã¾ã™ã€‚
- **ä»•æ§˜ã®æ˜ç¢ºåŒ–:** ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰è‡ªä½“ãŒã€Œå®Ÿè¡Œå¯èƒ½ãªä»•æ§˜æ›¸ã€ã¨ãªã‚Šã€AIã¸ã®æŒ‡ç¤ºãŒæ›–æ˜§ã«ãªã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚
- **ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³é˜²æ­¢:** å¾Œã®å¤‰æ›´ã§ãƒã‚°ãŒæ··å…¥ã—ã¦ã‚‚ã€ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šæ¤œçŸ¥å¯èƒ½ã§ã™ã€‚
