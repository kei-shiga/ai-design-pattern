# 5.1 CodeAct (Executable Code as Reasoning)

## 概要
AIに自然言語で推論させるのではなく、**「実行可能なコード（C#スクリプトやPowerShell）」を書かせ、それを実行した結果を元に次のアクションを決める**エージェントパターンです。
自然言語の曖昧さを排除し、複雑な計算やデータ処理におけるハルシネーション（幻覚）を劇的に減らすことができます。

## 詳細・実施手順

1. **実行環境の用意 (Sandbox):**
   * .NET Interactive (Polyglot Notebooks) や PowerShellセッションなど、AIが安全にコードを実行できる隔離環境を用意します。
   * 必要なNuGetパッケージやモジュールをプリインストールしておきます。

2. **Thought-Code-Observation Loop:**
   * **Thought:** AIが「何をすべきか」を思考します。
   * **Code:** 思考に基づき、C#スクリプト (.csx) や PowerShellコードを生成します。
   * **Observation:** 環境側でコードを実行し、標準出力やエラーログをAIに返します。
   * **Answer:** 実行結果を元に最終回答を生成します。

3. **ツールの統合:**
   * ファイル操作、Web検索、APIコールなども全て「関数/コマンドレット」として定義し、AIにはコード経由でこれらを呼び出させます。

## サンプルプロンプト

AIに対してCodeAct的な振る舞いを指示するプロンプト例です。

```markdown
# Role
あなたはC#スクリプトを実行して問題を解決するAIアシスタントです。

# Constraints
- 自然言語で長々と推論するのではなく、**まずコードを書いて検証**してください。
- 答えがわからない場合は、確認用のコード（Console.WriteLine等）を実行して情報を収集してください。
- ユーザーに回答する前に、必ず計算結果が正しいかコード実行で確かめてください。

# Tools
以下のメソッドが利用可能です。
- `SearchWeb(string query)`: Web検索を行います。
- `ReadFile(string path)`: ファイルを読み込みます。

# Example
User: "フィボナッチ数列の50番目は？"
Assistant:
```csharp
long Fib(int n) {
  long a = 0, b = 1;
  for (int i = 0; i < n; i++) {
    long temp = a;
    a = b;
    b = temp + b;
  }
  return a;
}
Console.WriteLine(Fib(50));
```

```
**Observation (実行結果):**
`12586269025`

**Assistant (最終回答):**
フィボナッチ数列の50番目は 12,586,269,025 です。
```

### このやり取りの意味
これは **Thought-Code-Observation Loop (思考・コード実行・観察のループ)** と呼ばれる、CodeActパターンの核心部分です。

1. **Assistant (AI)** が、「50番目のフィボナッチ数を計算するにはコードを書くのが確実だ」と考え、C#コードを出力しました。
2. **Observation (観察)** は、そのコードを実際にシステム（サンドボックス環境）が実行し、標準出力に表示された値（`12586269025`）をAIに返したものです。
3. **Assistant (AI)** は、この実行結果を見て「計算結果はこれだ」と確信し、最終的な日本語の回答を生成しました。

つまり、AIが頭の中で計算するのではなく、**「電卓（コード）」を叩いて、その画面を見てから答えている**状態です。

## メリット
- **正確性:** 数学的な計算やロジック処理をAIの確率的な推論ではなく、プログラムの決定論的な処理に委譲できます。
- **検証可能性:** 「どうやってその答えを出したか」がコードとして残るため、人間が検証可能です。
- **機能拡張:** Pythonライブラリを追加するだけで、AIの能力（グラフ描画、PDF解析など）を拡張できます。
